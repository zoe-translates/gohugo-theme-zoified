{{- $pctx := . -}}
{{- if .IsHome -}}{{ $pctx = .Site }}{{- end -}}
{{- $pages := slice -}}
{{- if $.IsHome -}}
    {{- $mainSections := site.Params.mainSections | default (slice "posts") }}
    {{- $pages = where $pctx.RegularPages.ByDate.Reverse "Section" "in" $mainSections -}}
{{- else if $.IsSection -}}
    {{- $pages = $pctx.RegularPages.ByDate.Reverse -}}
{{- else -}}
    {{- $pages = $pctx.Pages -}}
{{- end -}}
{{- $limit := site.Params.feedSize | default 25 -}}
{{- $pages = $pages | first $limit -}}
{{- printf "<?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"yes\" ?>" | safeHTML }}
<rss version="2.0"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:atom="http://www.w3.org/2005/Atom"
    xml:lang="{{ site.LanguageCode }}">
    <channel>
        {{ printf `<title><![CDATA[%s]]></title>` (partial "title.html" .) | safeHTML }}
        <link>{{ .Permalink }}</link>
        {{ with site.Params.description }}{{ printf `<description><![CDATA[%s]]></description>` . | safeHTML }}{{ end }}
        <generator>Hugo {{ hugo.Version }}</generator>{{ with site.Author.name }}
        {{ printf `<dc:creator><![CDATA[%s]]></dc:creator>` . | safeHTML }}{{ end }}{{ with site.LanguageCode }}
        <language>{{ . }}</language>{{ end }}{{ with site.Params.Copyright }}{{ $copyright := replace . "{year}" now.Year }}{{ $copyright = replace $copyright "&copy;" "Â©" }}
        <copyright>{{ $copyright | plainify }}</copyright>{{ end }}{{ if not site.LastChange.IsZero }}
        <lastBuildDate>{{ site.LastChange.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</lastBuildDate>{{ end }}
        <image>
            {{- $logo := resources.Get (site.Params.assets.logo | default "/img/open-graph-logo.png") }}{{ $logo = $logo.Resize "96x96" }}
            <url>{{ $logo.Permalink | absURL }}</url>
            {{ printf `<title><![CDATA[%s]]></title>` (partial "title.html" .) | safeHTML }}
            <link>{{ .Permalink }}</link>
            <width>{{ $logo.Width }}</width>
            <height>{{ $logo.Height }}</height>
        </image>
        {{ printf `<atom:link href=%q rel="self" type="application/rss+xml" title="Feed" />` (printf "%s%s" .Permalink "feeds/feed.rss.xml") | safeHTML }}
        {{- $output_formats := .AlternativeOutputFormats }}
        {{- range $output_formats -}}
        {{- with $output_formats.Get .Name }}
        {{ printf `<atom:link href=%q rel="alternate" type=%q title=%q />` .Permalink .MediaType.Type .Name | safeHTML }}
        {{- end -}}
        {{- end }}
        {{- range $pages }}
        <item>
            {{ printf `<title><![CDATA[%s]]></title>` .Title | safeHTML }}
            <link>{{ .Permalink }}</link>
            <pubDate>{{ .Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</pubDate>
            <category>{{ .Section }}</category>{{ range (.GetTerms "tags") }}
            <category>{{ .LinkTitle }}</category>{{end}}
            <guid isPermaLink="false">{{ md5 .Permalink }}</guid>
            {{ printf `<description><![CDATA[%s]]></description>` .Summary | safeHTML }}
        </item>
        {{- end }}
    </channel>
</rss>
