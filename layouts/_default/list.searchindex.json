{{- /* Generate the search index. */ -}}
{{- $pages := slice -}}
{{- $mainSections := site.Params.mainSections | default (slice "posts") }}
{{- $pages = where site.RegularPages.ByDate.Reverse "Section" "in" $mainSections -}}
{{- $.Scratch.Add "pagesIndex" slice -}}
{{- $.Scratch.Add "urlsAdded" slice -}}
{{- $i := 0 -}}
{{- range $index, $page := $pages -}}
  {{- /* Do not index drafts or private pages. */ -}}
  {{- if and (not .Draft) (not .Params.private) | and (ne .Params.searchable false) -}}
    {{- /* Do not index pages w/o content. */ -}}
    {{- if gt (len $page.Content) 0 -}}
      {{- /* Add page to index. */ -}}
      {{- if not (in ($.Scratch.Get "urlsAdded") $page.Permalink) -}}
        {{- /* Exclude virtual pages which aren't backed by a file */ -}}
        {{- if .File -}}
          {{- $publishDate := $page.Date.Format "2 January 2006" -}}
          {{- $pageauth := $page.Params.author | default "Anonymous" -}}
          {{- $pageData := (dict
            "revid" $i
            "href" $page.RelPermalink
            "content" (trim $page.Plain "\n ")
            "title" $page.Title
            "author" $pageauth
            "date" $publishDate
            "section" $page.Section
            "tag" ($page.Params.tags | default slice)
          ) -}}
          {{- $.Scratch.Add "pagesIndex" $pageData -}}
          {{- $.Scratch.Add "urlsAdded" $page.Permalink -}}
          {{- $i = add $i 1 -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $.Scratch.Get "pagesIndex" | jsonify -}}
