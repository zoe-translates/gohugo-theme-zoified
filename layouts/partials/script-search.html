{{- $jsOpts := dict "format" "iife" "minify" hugo.IsProduction "target" "es2017" -}}
{{- if (not hugo.IsProduction) -}}
  {{- $jsOpts = $jsOpts | merge (dict "sourceMap" "external") -}}
{{- end -}}
{{- /* Un-hide the JS search form */ -}}
{{- $unhide := resources.Get "js/show-search.js" | js.Build $jsOpts -}}
{{- if or (site.Params.assets.disable_fingerprinting) (not hugo.IsProduction) }}
    <script src="{{ $unhide.RelPermalink }}" defer></script>
{{- else -}}
    {{- $unhide = $unhide | fingerprint }}
    <script src="{{ $unhide.RelPermalink }}" integrity="{{ $unhide.Data.Integrity }}" defer></script>
{{- end -}}

{{- /* Add lunr.js. */ -}}
{{- $lunrSearch := slice (resources.Get "js/vendor/lunr.js") -}}

{{- /* Add lunr multilanguage support. */ -}}
{{- $lunrLanguages := site.Params.search.languages | default slice -}}
{{- if gt (len $lunrLanguages) 0 -}}

    {{- $lunrSearch = $lunrSearch | append (resources.Get "js/vendor/lunr.stemmer.support.js") -}}

    {{- range $lunrLanguages -}}
        {{- $lang := . -}}
        {{- $lang = $lang | lower -}}
        {{- if and $lang (ne $lang "en") -}}
            {{- $lunrSearch = $lunrSearch | append (resources.Get (printf "js/vendor/lunr.%s.js" $lang)) -}}
        {{- end -}}
    {{- end -}}

    {{- $lunrSearch = $lunrSearch | append (resources.Get "js/vendor/lunr.multi.js") -}}

{{- end -}}

{{- /* Build lunr - don't do js.Build. */ -}}
{{- $lunrSearch = $lunrSearch | resources.Concat "js/lunr-bundle.js" -}}
{{- if hugo.IsProduction -}}
  {{- $lunrSearch = minify $lunrSearch -}}
{{- end -}}

{{- if or (site.Params.assets.disable_fingerprinting) (not hugo.IsProduction) }}
    <script src="{{ $lunrSearch.RelPermalink }}" defer></script>
{{- else -}}
    {{- $lunrSearch = $lunrSearch | fingerprint }}
    <script src="{{ $lunrSearch.RelPermalink }}" integrity="{{ $lunrSearch.Data.Integrity }}" defer></script>
{{- end -}}

{{- /* Configure search engine. */ -}}
{{- $maxResults := site.Params.search.maxResults | default 25 -}}
{{- $maxHitsPerResult := site.Params.search.maxHitsPerResult | default 5 -}}
{{- $searchConfig := dict "indexURI" "/searchindex.json" "maxResults" $maxResults "maxHitsPerResult" $maxHitsPerResult "lunrLanguages" $lunrLanguages -}}
{{- $searchI18n := dict "noResults" (i18n "search_no_results") -}}
{{- $searchParams := dict "searchConfig" $searchConfig "i18n" $searchI18n -}}

{{- $siteSearch := slice -}}
{{- $siteSearch = $siteSearch | append (resources.Get "js/search.js") -}}
{{- $siteSearch = $siteSearch | resources.Concat "js/search-bundle.js" -}}

{{- $siteSearch = $siteSearch | js.Build (merge $jsOpts (dict "params" $searchParams)) -}}

{{- if or (site.Params.assets.disable_fingerprinting) (not hugo.IsProduction) }}
    <script src="{{ $siteSearch.RelPermalink }}" defer></script>
{{- else -}}
    {{- $siteSearch = $siteSearch | fingerprint }}
    <script src="{{ $siteSearch.RelPermalink }}" integrity="{{ $siteSearch.Data.Integrity }}" defer></script>
{{- end -}}

